# 需求文档

## 简介

Mira 是一个跨平台桌面录像软件，使用 Rust 开发，支持 Windows、macOS、Android 和 iOS。本文档定义了 MVP（最小可行产品）版本的核心功能需求，聚焦于基础摄像头窗口显示、形状自定义、窗口交互和设备管理。

## 术语表

- **Mira**: 桌面摄像精灵应用程序
- **摄像头窗口**: 显示摄像头实时画面的桌面悬浮窗口
- **形状遮罩**: 应用于摄像头画面的几何形状裁剪效果
- **预设形状**: 系统内置的标准几何形状（圆形、方形等）
- **摄像头设备**: 系统中可用的物理或虚拟摄像头硬件
- **窗口句柄**: 操作系统用于标识和管理窗口的唯一标识符
- **帧缓冲区**: 存储摄像头捕获的单帧图像数据的内存区域

## 需求

### 需求 1: 摄像头设备管理

**用户故事:** 作为用户，我想要检测和选择可用的摄像头设备，以便我可以使用不同的摄像头进行录制。

#### 验收标准

1. WHEN Mira 启动时，THE 系统 SHALL 枚举所有可用的摄像头设备
2. WHEN 检测到多个摄像头设备时，THE 系统 SHALL 提供设备列表供用户选择
3. WHEN 用户选择一个摄像头设备时，THE 系统 SHALL 激活该设备并开始捕获视频流
4. WHEN 摄像头设备不可用或被占用时，THE 系统 SHALL 返回明确的错误信息
5. WHEN 用户切换摄像头设备时，THE 系统 SHALL 释放当前设备并激活新设备
6. THE 系统 SHALL 以至少 30 FPS 的帧率捕获视频流

### 需求 2: 摄像头窗口显示

**用户故事:** 作为用户，我想要一个始终显示在最上层的摄像头窗口，以便在使用其他应用时也能看到摄像头画面。

#### 验收标准

1. WHEN 摄像头设备激活后，THE 摄像头窗口 SHALL 在桌面上显示实时视频流
2. THE 摄像头窗口 SHALL 始终保持在所有其他窗口之上（置顶显示）
3. WHEN 其他应用获得焦点时，THE 摄像头窗口 SHALL 保持可见且置顶
4. THE 摄像头窗口 SHALL 以至少 30 FPS 的帧率渲染视频流
5. WHEN 视频帧到达时，THE 系统 SHALL 在 33 毫秒内完成渲染（保证流畅性）
6. THE 摄像头窗口 SHALL 支持透明背景（窗口边界外的区域透明）

### 需求 3: 形状遮罩系统

**用户故事:** 作为用户，我想要将摄像头画面裁剪成不同的形状，以便创造更有趣的视觉效果。

#### 验收标准

1. THE 系统 SHALL 提供至少 5 种预设形状（圆形、椭圆形、方形、圆角矩形、心形）
2. WHEN 用户选择一个预设形状时，THE 系统 SHALL 将该形状遮罩应用于摄像头画面
3. WHEN 应用形状遮罩时，THE 系统 SHALL 保持视频流的帧率不低于 30 FPS
4. WHEN 形状遮罩改变时，THE 系统 SHALL 在 100 毫秒内完成切换
5. THE 系统 SHALL 将形状遮罩外的区域渲染为透明
6. WHEN 窗口尺寸改变时，THE 系统 SHALL 自动调整形状遮罩以适应新尺寸

### 需求 4: 窗口拖拽功能

**用户故事:** 作为用户，我想要自由拖拽摄像头窗口到屏幕任意位置，以便将其放置在最合适的位置。

#### 验收标准

1. WHEN 用户在摄像头窗口上按下鼠标左键时，THE 系统 SHALL 进入拖拽模式
2. WHILE 处于拖拽模式，THE 系统 SHALL 跟随鼠标移动更新窗口位置
3. WHEN 用户释放鼠标左键时，THE 系统 SHALL 退出拖拽模式并固定窗口位置
4. WHILE 拖拽窗口时，THE 系统 SHALL 保持视频流的正常渲染
5. WHEN 窗口被拖拽到屏幕边界外时，THE 系统 SHALL 限制窗口位置使其至少有 20% 的区域保持在屏幕内
6. THE 系统 SHALL 在 16 毫秒内响应鼠标移动事件（保证拖拽流畅性）

### 需求 5: 窗口缩放功能

**用户故事:** 作为用户，我想要调整摄像头窗口的大小，以便根据需要放大或缩小画面。

#### 验收标准

1. WHEN 用户使用鼠标滚轮滚动时，THE 系统 SHALL 按比例缩放窗口尺寸
2. WHEN 用户向上滚动鼠标滚轮时，THE 系统 SHALL 增大窗口尺寸（每次滚动增加 10%）
3. WHEN 用户向下滚动鼠标滚轮时，THE 系统 SHALL 减小窗口尺寸（每次滚动减少 10%）
4. THE 系统 SHALL 限制窗口最小尺寸为 100x100 像素
5. THE 系统 SHALL 限制窗口最大尺寸为屏幕分辨率的 80%
6. WHEN 窗口缩放时，THE 系统 SHALL 保持窗口的宽高比不变
7. WHEN 窗口缩放时，THE 系统 SHALL 保持视频流的帧率不低于 30 FPS

### 需求 6: 窗口旋转功能

**用户故事:** 作为用户，我想要旋转摄像头窗口，以便调整画面的方向。

#### 验收标准

1. WHEN 用户按住 Ctrl 键并滚动鼠标滚轮时，THE 系统 SHALL 旋转窗口
2. WHEN 用户向上滚动时，THE 系统 SHALL 顺时针旋转窗口（每次滚动 15 度）
3. WHEN 用户向下滚动时，THE 系统 SHALL 逆时针旋转窗口（每次滚动 15 度）
4. THE 系统 SHALL 支持 0 到 360 度的任意旋转角度
5. WHEN 窗口旋转时，THE 系统 SHALL 保持视频流的帧率不低于 30 FPS
6. WHEN 旋转角度为 0、90、180 或 270 度时，THE 系统 SHALL 自动对齐到精确角度（误差范围 ±5 度）

### 需求 7: 应用程序生命周期管理

**用户故事:** 作为用户，我想要正常启动和关闭应用程序，以便安全地使用和退出软件。

#### 验收标准

1. WHEN 用户启动 Mira 时，THE 系统 SHALL 在 3 秒内完成初始化并显示摄像头窗口
2. WHEN 用户关闭应用程序时，THE 系统 SHALL 释放所有摄像头设备资源
3. WHEN 用户关闭应用程序时，THE 系统 SHALL 保存当前的窗口位置、尺寸和旋转角度
4. WHEN 用户再次启动应用程序时，THE 系统 SHALL 恢复上次保存的窗口状态
5. IF 应用程序崩溃或异常退出，THEN THE 系统 SHALL 确保摄像头设备被正确释放
6. THE 系统 SHALL 将配置数据持久化到本地存储

### 需求 8: 错误处理与用户反馈

**用户故事:** 作为用户，我想要在出现错误时收到清晰的提示信息，以便了解问题并采取相应措施。

#### 验收标准

1. WHEN 没有检测到摄像头设备时，THE 系统 SHALL 显示友好的错误提示
2. WHEN 摄像头设备访问被拒绝时，THE 系统 SHALL 提示用户检查权限设置
3. WHEN 摄像头设备被其他应用占用时，THE 系统 SHALL 提示用户关闭占用设备的应用
4. WHEN 视频流捕获失败时，THE 系统 SHALL 记录错误日志并尝试重新连接
5. WHEN 系统资源不足时，THE 系统 SHALL 降低视频质量以保持应用运行
6. THE 系统 SHALL 将所有错误信息记录到日志文件中

### 需求 9: 跨平台兼容性

**用户故事:** 作为用户，我想要在不同操作系统上使用 Mira，以便在我的所有设备上获得一致的体验。

#### 验收标准

1. THE 系统 SHALL 在 Windows 10 及以上版本上正常运行
2. THE 系统 SHALL 在 macOS 11 (Big Sur) 及以上版本上正常运行
3. WHEN 在不同平台上运行时，THE 系统 SHALL 提供一致的核心功能
4. WHEN 在不同平台上运行时，THE 系统 SHALL 遵循各平台的 UI 设计规范
5. THE 系统 SHALL 使用平台原生 API 访问摄像头设备
6. THE 系统 SHALL 使用平台原生 API 创建置顶窗口

### 需求 10: 性能要求

**用户故事:** 作为用户，我想要应用程序流畅运行且资源占用合理，以便不影响其他应用的使用。

#### 验收标准

1. THE 系统 SHALL 在空闲状态下占用不超过 100 MB 内存
2. THE 系统 SHALL 在运行状态下占用不超过 200 MB 内存
3. THE 系统 SHALL 在运行状态下 CPU 占用率不超过 15%
4. WHEN 应用形状遮罩和旋转效果时，THE 系统 SHALL 保持 CPU 占用率不超过 25%
5. THE 系统 SHALL 在启动后 5 秒内达到稳定的内存占用
6. THE 系统 SHALL 不产生内存泄漏（长时间运行内存占用保持稳定）

### 需求 12: UI 控制界面

**用户故事:** 作为用户，我想要在鼠标悬浮在窗口上时看到控制按钮，以便我可以方便地关闭或最小化应用程序。

#### 验收标准

1. WHEN 鼠标进入窗口区域时，THE 系统 SHALL 开始计时悬浮时间
2. WHEN 鼠标在窗口区域内悬浮超过 500 毫秒时，THE 系统 SHALL 显示控制按钮
3. WHEN 显示控制按钮时，THE 系统 SHALL 在窗口右上角显示关闭按钮（红色圆形，带白色 X）
4. WHEN 显示控制按钮时，THE 系统 SHALL 在关闭按钮左侧显示最小化按钮（灰色圆形，带白色减号）
5. WHEN 用户点击关闭按钮时，THE 系统 SHALL 保存配置并退出应用程序
6. WHEN 用户点击最小化按钮时，THE 系统 SHALL 最小化窗口到任务栏
7. WHEN 鼠标离开窗口区域时，THE 系统 SHALL 隐藏控制按钮
8. THE 控制按钮 SHALL 具有半透明背景，不影响视频内容的可见性
9. THE 控制按钮 SHALL 具有 20x20 像素的尺寸，便于点击
10. THE 控制按钮 SHALL 在鼠标悬浮时提供视觉反馈（高亮效果）

### 需求 13: 右键上下文菜单

**用户故事:** 作为用户，我想要通过右键菜单访问所有功能，以便我可以快速切换形状、摄像头设备和窗口控制选项。

#### 验收标准

1. WHEN 用户在窗口区域内右键点击时，THE 系统 SHALL 显示上下文菜单
2. THE 上下文菜单 SHALL 包含形状切换选项（圆形、椭圆形、矩形、圆角矩形、心形）
3. THE 上下文菜单 SHALL 包含摄像头设备切换选项
4. THE 上下文菜单 SHALL 包含窗口控制选项（重置位置、重置旋转）
5. THE 上下文菜单 SHALL 显示当前状态信息（当前形状、窗口尺寸、位置、旋转角度）
6. WHEN 用户选择菜单项时，THE 系统 SHALL 执行相应的操作
7. WHEN 用户点击菜单外区域时，THE 系统 SHALL 隐藏上下文菜单
8. THE 上下文菜单 SHALL 具有半透明背景和清晰的文字显示
9. THE 上下文菜单 SHALL 在鼠标位置附近显示，不超出屏幕边界

### 需求 14: 形状视觉差异化

**用户故事:** 作为用户，我想要椭圆形和圆形有明显的视觉区别，心形有合适的大小，以便我可以清楚地区分不同的形状效果。

#### 验收标准

1. WHEN 窗口为非正方形尺寸时，THE 椭圆形遮罩 SHALL 明显不同于圆形遮罩
2. THE 椭圆形遮罩 SHALL 适应窗口的宽高比，呈现椭圆形状
3. THE 圆形遮罩 SHALL 始终保持圆形，使用窗口较小边作为直径
4. THE 心形遮罩 SHALL 占据窗口面积的至少 60%，确保清晰可见
5. THE 心形遮罩 SHALL 居中显示，保持正确的心形比例
6. WHEN 用户切换形状时，THE 系统 SHALL 在 100 毫秒内完成形状变更
7. THE 所有形状 SHALL 具有平滑的边缘，无锯齿效果

### 需求 15: 拖拽性能优化

**用户故事:** 作为用户，我想要拖拽窗口时完全流畅无卡顿，以便获得最佳的用户体验。

#### 验收标准

1. WHEN 用户拖拽窗口时，THE 系统 SHALL 在 8 毫秒内响应鼠标移动事件
2. THE 窗口位置更新 SHALL 与鼠标移动完全同步，无延迟或跳跃
3. THE 系统 SHALL 使用位置变化阈值 0.05 像素，确保最高精度
4. WHEN 拖拽过程中，THE 系统 SHALL 跳过边界检查，仅在拖拽结束时应用约束
5. THE 系统 SHALL 使用直接的窗口 API 调用，避免额外的验证步骤
6. THE 拖拽操作 SHALL 不影响视频渲染帧率，保持 30+ FPS
7. THE 系统 SHALL 优化内存分配，避免拖拽过程中的临时对象创建
