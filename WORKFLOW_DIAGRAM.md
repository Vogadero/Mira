# Mira 工作流程图

## 完整发布流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     触发条件                                      │
├─────────────────────────────────────────────────────────────────┤
│  1. Push 到 main/master (包含 [release])                         │
│  2. 手动触发 (勾选 create_release)                               │
│  3. 推送标签 (v*)                                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   阶段 1: 并行构建                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   Windows    │  │    macOS     │  │    Linux     │          │
│  │   构建任务    │  │   构建任务    │  │   构建任务    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│         │                 │                 │                    │
│         └─────────────────┴─────────────────┘                    │
│                           │                                      │
│                    所有构建成功？                                 │
│                           │                                      │
│              ┌────────────┴────────────┐                        │
│              │                         │                        │
│             是                         否                        │
│              │                         │                        │
│              ▼                         ▼                        │
│         继续下一步                  ❌ 停止                       │
│                                   (不创建标签)                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              阶段 2: 自动打标签 (条件执行)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  条件检查:                                                        │
│  • 是 push 事件 (不是 PR)                                         │
│  • 不是标签推送                                                   │
│  • 提交消息包含 [release] 或手动触发时勾选                         │
│  • 所有构建成功                                                   │
│                                                                   │
│  执行步骤:                                                        │
│  1. 获取最新标签 (例如: v1.0.0)                                   │
│  2. 计算新版本 (例如: v1.0.1)                                     │
│  3. 更新 Cargo.toml                                              │
│  4. 提交版本变更                                                  │
│  5. 创建并推送标签                                                │
│                                                                   │
│  输出: new_tag, should_release                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                阶段 3: 创建发布 (条件执行)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  条件检查:                                                        │
│  • 是标签推送 或 auto-tag 成功                                    │
│  • 所有构建任务成功                                               │
│                                                                   │
│  执行步骤:                                                        │
│  1. 下载所有平台的构建产物                                         │
│     • mira-windows-x64                                           │
│     • mira-macos-x64                                             │
│     • mira-linux-x64                                             │
│                                                                   │
│  2. 创建压缩包                                                    │
│     • Windows: ZIP                                               │
│     • macOS: TAR.GZ                                              │
│     • Linux: TAR.GZ                                              │
│                                                                   │
│  3. 生成 SHA256 校验和                                            │
│                                                                   │
│  4. 创建 GitHub Release                                          │
│     • 上传所有压缩包                                              │
│     • 上传校验和文件                                              │
│     • 生成发布说明                                                │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                        ✅ 发布完成！
```

## 三种触发方式对比

### 方式 1: 提交消息 [release]

```
开发者推送代码 (包含 [release])
    │
    ▼
构建所有平台 ──✅──> 自动打标签 ──✅──> 创建发布
    │
    └──❌──> 停止 (不创建标签)
```

**优点**：
- ✅ 最简单，只需在提交消息中添加 `[release]`
- ✅ 自动化程度最高
- ✅ 构建失败不会创建标签

**适用场景**：
- 日常开发的小版本发布
- Bug 修复发布

### 方式 2: 手动触发

```
开发者在 Actions 页面手动触发
    │
    ├─ 选择版本类型 (major/minor/patch)
    └─ 勾选 create_release
    │
    ▼
构建所有平台 ──✅──> 自动打标签 ──✅──> 创建发布
    │
    └──❌──> 停止 (不创建标签)
```

**优点**：
- ✅ 可以精确控制版本号
- ✅ 可以选择是否创建发布
- ✅ 适合重要版本发布

**适用场景**：
- 主要版本发布 (major)
- 功能版本发布 (minor)
- 需要精确控制的发布

### 方式 3: 手动创建标签

```
开发者手动创建并推送标签
    │
    ▼
构建所有平台 ──✅──> 跳过 auto-tag ──✅──> 创建发布
    │
    └──❌──> 停止 (标签已存在)
```

**优点**：
- ✅ 跳过自动打标签步骤
- ✅ 适合紧急发布
- ✅ 可以使用任意版本号

**适用场景**：
- 紧急修复
- 特殊版本号
- 重新发布已有版本

## 失败处理

### 构建失败

```
构建失败 ──❌──> 停止
    │
    └─ 不创建标签
    └─ 不创建发布
    └─ 开发者修复后重新推送
```

### 打标签失败

```
构建成功 ──✅──> 打标签失败 ──❌──> 停止
    │
    └─ 标签未创建
    └─ 不创建发布
    └─ 检查标签是否已存在
```

### 发布失败

```
构建成功 ──✅──> 打标签成功 ──✅──> 发布失败 ──❌──> 停止
    │
    └─ 标签已创建
    └─ 发布未创建
    └─ 可以手动创建发布或重新推送标签
```

## 工作流文件

所有逻辑都在一个文件中：`.github/workflows/build.yml`

**优势**：
- ✅ 单一真相来源
- ✅ 易于维护
- ✅ 原子性操作
- ✅ 清晰的依赖关系

## 相关文档

- [RELEASE_PROCESS.md](RELEASE_PROCESS.md) - 详细发布流程
- [.github/workflows/build.yml](.github/workflows/build.yml) - 工作流配置
