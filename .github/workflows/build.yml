name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Build release
      run: |
        cargo build --release --verbose --bin mira
    
    - name: Create distribution package
      run: |
        # ÂàõÂª∫ÂàÜÂèëÁõÆÂΩï
        New-Item -ItemType Directory -Force -Path dist
        
        # Â§çÂà∂Êñá‰ª∂
        Copy-Item target\release\mira.exe dist\
        Copy-Item README.md dist\
        Copy-Item LICENSE dist\
        
        # ÂàõÂª∫ÁâàÊú¨Êñá‰ª∂
        echo "Mira Desktop Camera v1.0.0" | Out-File -FilePath dist\VERSION.txt -Encoding UTF8
        echo "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File -FilePath dist\VERSION.txt -Append -Encoding UTF8
        echo "Platform: Windows x64" | Out-File -FilePath dist\VERSION.txt -Append -Encoding UTF8
        
        # Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è
        $size = (Get-Item target\release\mira.exe).Length / 1MB
        Write-Host "Binary size: $([math]::Round($size, 2)) MB"
        
        if ($size -gt 20) {
          Write-Warning "Binary size exceeds 20MB target"
        } else {
          Write-Host "‚úì Binary size within target (<20MB)"
        }
    
    - name: Create ZIP archive
      run: |
        Compress-Archive -Path dist\* -DestinationPath mira-windows-x64.zip
        
        # Ê£ÄÊü•ÂéãÁº©ÂåÖÂ§ßÂ∞è
        $zipSize = (Get-Item mira-windows-x64.zip).Length / 1MB
        Write-Host "ZIP size: $([math]::Round($zipSize, 2)) MB"
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: mira-windows-x64
        path: mira-windows-x64.zip
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Install dependencies
      run: |
        # ÂÆâË£ÖÂøÖË¶ÅÂ∑•ÂÖ∑
        brew install bc
        rustc --version
        cargo --version
    
    - name: Build release
      run: |
        cargo build --release --verbose --bin mira
    
    - name: Create distribution package
      run: |
        # ÂàõÂª∫ÂàÜÂèëÁõÆÂΩï
        mkdir -p dist
        
        # Â§çÂà∂Êñá‰ª∂
        cp target/release/mira dist/
        cp README.md dist/
        cp LICENSE dist/
        
        # ÂàõÂª∫ÁâàÊú¨Êñá‰ª∂
        cat > dist/VERSION.txt << EOF
        Mira Desktop Camera v1.0.0
        Build Date: $(date '+%Y-%m-%d %H:%M:%S')
        Platform: macOS x64
        EOF
        
        # Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è
        size=$(du -m target/release/mira | cut -f1)
        echo "Binary size: ${size} MB"
        
        if [ $size -gt 25 ]; then
          echo "‚ö†Ô∏è  Binary size exceeds 25MB target"
        else
          echo "‚úì Binary size within target (<25MB)"
        fi
    
    - name: Create TAR archive
      run: |
        tar -czf mira-macos-x64.tar.gz -C dist .
        
        # Ê£ÄÊü•ÂéãÁº©ÂåÖÂ§ßÂ∞è
        tarSize=$(du -m mira-macos-x64.tar.gz | cut -f1)
        echo "TAR size: ${tarSize} MB"
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: mira-macos-x64
        path: mira-macos-x64.tar.gz
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libssl-dev \
          libudev-dev \
          libv4l-dev \
          bc
    
    - name: Build release
      run: |
        cargo build --release --verbose --bin mira
    
    - name: Create distribution package
      run: |
        # ÂàõÂª∫ÂàÜÂèëÁõÆÂΩï
        mkdir -p dist
        
        # Â§çÂà∂Êñá‰ª∂
        cp target/release/mira dist/
        cp README.md dist/
        cp LICENSE dist/
        
        # ÂàõÂª∫ÁâàÊú¨Êñá‰ª∂
        cat > dist/VERSION.txt << EOF
        Mira Desktop Camera v1.0.0
        Build Date: $(date '+%Y-%m-%d %H:%M:%S')
        Platform: Linux x64
        EOF
        
        # Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è
        size=$(du -m target/release/mira | cut -f1)
        echo "Binary size: ${size} MB"
        
        if [ $size -gt 30 ]; then
          echo "‚ö†Ô∏è  Binary size exceeds 30MB target"
        else
          echo "‚úì Binary size within target (<30MB)"
        fi
    
    - name: Create TAR archive
      run: |
        tar -czf mira-linux-x64.tar.gz -C dist .
        
        # Ê£ÄÊü•ÂéãÁº©ÂåÖÂ§ßÂ∞è
        tarSize=$(du -m mira-linux-x64.tar.gz | cut -f1)
        echo "TAR size: ${tarSize} MB"
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: mira-linux-x64
        path: mira-linux-x64.tar.gz
        retention-days: 30

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: mira-windows-x64
        path: ./artifacts
    
    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: mira-macos-x64
        path: ./artifacts
    
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: mira-linux-x64
        path: ./artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./artifacts/mira-windows-x64.zip
          ./artifacts/mira-macos-x64.tar.gz
          ./artifacts/mira-linux-x64.tar.gz
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## Mira Desktop Camera v${{ github.ref_name }}
          
          üé• **Ê°åÈù¢ÊëÑÂÉèÁ≤æÁÅµ** - Áé∞‰ª£ÂåñÁöÑÊ°åÈù¢ÊëÑÂÉèÂ§¥Â∫îÁî®
          
          ### ÂäüËÉΩÁâπÊÄß
          - üé® 5ÁßçÂΩ¢Áä∂ÈÅÆÁΩ©ÔºàÂúÜÂΩ¢„ÄÅÊ§≠ÂúÜ„ÄÅÁü©ÂΩ¢„ÄÅÂúÜËßíÁü©ÂΩ¢„ÄÅÂøÉÂΩ¢Ôºâ
          - üñ±Ô∏è ÁÅµÊ¥ª‰∫§‰∫íÔºàÊãñÊãΩ„ÄÅÁº©Êîæ„ÄÅÊóãËΩ¨Ôºâ
          - üöÄ È´òÊÄßËÉΩGPUÊ∏≤ÊüìÔºà30+ FPSÔºâ
          - üíæ Êô∫ËÉΩÈÖçÁΩÆ‰øùÂ≠ò
          - üåç Ë∑®Âπ≥Âè∞ÊîØÊåÅ
          
          ### ‰∏ãËΩΩËØ¥Êòé
          - **Windows**: ‰∏ãËΩΩ `mira-windows-x64.zip`
          - **macOS**: ‰∏ãËΩΩ `mira-macos-x64.tar.gz`
          - **Linux**: ‰∏ãËΩΩ `mira-linux-x64.tar.gz`
          
          ### ‰ΩøÁî®ÊñπÊ≥ï
          1. Ëß£Âéã‰∏ãËΩΩÁöÑÊñá‰ª∂
          2. ËøêË°å `mira` Êàñ `mira.exe`
          3. Êéà‰∫àÊëÑÂÉèÂ§¥ÊùÉÈôê
          4. ÂºÄÂßã‰ΩøÁî®ÔºÅ
          
          ËØ¶ÁªÜ‰ΩøÁî®ËØ¥ÊòéËØ∑ÂèÇËÄÉ [README.md](https://github.com/Vogadero/Mira/blob/main/README.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
