name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Build release
      run: |
        cargo build --release --verbose --bin mira
    
    - name: Create distribution package
      run: |
        # åˆ›å»ºåˆ†å‘ç›®å½•
        New-Item -ItemType Directory -Force -Path dist
        
        # å¤åˆ¶æ–‡ä»¶
        Copy-Item target\release\mira.exe dist\
        Copy-Item README.md dist\
        Copy-Item LICENSE dist\
        
        # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
        echo "Mira Desktop Camera v1.0.0" | Out-File -FilePath dist\VERSION.txt -Encoding UTF8
        echo "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File -FilePath dist\VERSION.txt -Append -Encoding UTF8
        echo "Platform: Windows x64" | Out-File -FilePath dist\VERSION.txt -Append -Encoding UTF8
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        $size = (Get-Item target\release\mira.exe).Length / 1MB
        Write-Host "Binary size: $([math]::Round($size, 2)) MB"
        
        if ($size -gt 20) {
          Write-Warning "Binary size exceeds 20MB target"
        } else {
          Write-Host "âœ“ Binary size within target (<20MB)"
        }
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: mira-windows-x64
        path: dist/
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Install dependencies
      run: |
        # å®‰è£…å¿…è¦å·¥å…·
        brew install bc
        rustc --version
        cargo --version
    
    - name: Build release
      run: |
        cargo build --release --verbose --bin mira
    
    - name: Create distribution package
      run: |
        # åˆ›å»ºåˆ†å‘ç›®å½•
        mkdir -p dist
        
        # å¤åˆ¶æ–‡ä»¶
        cp target/release/mira dist/
        cp README.md dist/
        cp LICENSE dist/
        
        # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
        cat > dist/VERSION.txt << EOF
        Mira Desktop Camera v1.0.0
        Build Date: $(date '+%Y-%m-%d %H:%M:%S')
        Platform: macOS x64
        EOF
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        size=$(du -m target/release/mira | cut -f1)
        echo "Binary size: ${size} MB"
        
        if [ $size -gt 25 ]; then
          echo "âš ï¸  Binary size exceeds 25MB target"
        else
          echo "âœ“ Binary size within target (<25MB)"
        fi
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: mira-macos-x64
        path: dist/
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libssl-dev \
          libudev-dev \
          libv4l-dev \
          libgtk-3-dev \
          libglib2.0-dev \
          libappindicator3-dev \
          libxdo-dev \
          bc
    
    - name: Build release
      run: |
        cargo build --release --verbose --bin mira
    
    - name: Create distribution package
      run: |
        # åˆ›å»ºåˆ†å‘ç›®å½•
        mkdir -p dist
        
        # å¤åˆ¶æ–‡ä»¶
        cp target/release/mira dist/
        cp README.md dist/
        cp LICENSE dist/
        
        # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
        cat > dist/VERSION.txt << EOF
        Mira Desktop Camera v1.0.0
        Build Date: $(date '+%Y-%m-%d %H:%M:%S')
        Platform: Linux x64
        EOF
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        size=$(du -m target/release/mira | cut -f1)
        echo "Binary size: ${size} MB"
        
        if [ $size -gt 30 ]; then
          echo "âš ï¸  Binary size exceeds 30MB target"
        else
          echo "âœ“ Binary size within target (<30MB)"
        fi
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: mira-linux-x64
        path: dist/
        retention-days: 30

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: mira-windows-x64
        path: ./windows-dist
    
    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: mira-macos-x64
        path: ./macos-dist
    
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: mira-linux-x64
        path: ./linux-dist
    
    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Create release packages
      run: |
        # åˆ›å»º artifacts ç›®å½•
        mkdir -p artifacts
        
        # æ‰“åŒ… Windows (ZIP)
        cd windows-dist
        zip -r ../artifacts/mira-windows-x64.zip *
        cd ..
        
        # æ‰“åŒ… macOS (TAR.GZ)
        cd macos-dist
        tar -czf ../artifacts/mira-macos-x64.tar.gz *
        cd ..
        
        # æ‰“åŒ… Linux (TAR.GZ)
        cd linux-dist
        tar -czf ../artifacts/mira-linux-x64.tar.gz *
        cd ..
        
        # ç”Ÿæˆæ ¡éªŒå’Œ
        cd artifacts
        sha256sum mira-windows-x64.zip > checksums.txt
        sha256sum mira-macos-x64.tar.gz >> checksums.txt
        sha256sum mira-linux-x64.tar.gz >> checksums.txt
        cat checksums.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./artifacts/mira-windows-x64.zip
          ./artifacts/mira-macos-x64.tar.gz
          ./artifacts/mira-linux-x64.tar.gz
          ./artifacts/checksums.txt
        draft: false
        prerelease: false
        generate_release_notes: true
        name: Mira v${{ steps.get_version.outputs.version }}
        body: |
          ## ğŸ¥ Mira Desktop Camera v${{ steps.get_version.outputs.version }}
          
          **æ¡Œé¢æ‘„åƒç²¾çµ** - ç°ä»£åŒ–çš„æ¡Œé¢æ‘„åƒå¤´åº”ç”¨
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸ¨ **5ç§å½¢çŠ¶é®ç½©**: åœ†å½¢ã€æ¤­åœ†ã€çŸ©å½¢ã€åœ†è§’çŸ©å½¢ã€å¿ƒå½¢
          - ğŸ–±ï¸ **çµæ´»äº¤äº’**: æ‹–æ‹½ç§»åŠ¨ã€æ»šè½®ç¼©æ”¾ã€Ctrl+æ»šè½®æ—‹è½¬
          - ğŸš€ **é«˜æ€§èƒ½æ¸²æŸ“**: GPUåŠ é€Ÿï¼Œç¨³å®š30+ FPS
          - ğŸ’¾ **æ™ºèƒ½é…ç½®**: è‡ªåŠ¨ä¿å­˜çª—å£çŠ¶æ€å’Œåå¥½è®¾ç½®
          - ğŸŒ **è·¨å¹³å°æ”¯æŒ**: Windowsã€macOSã€Linux
          - âš¡ **ä½èµ„æºå ç”¨**: CPU < 25%ï¼Œå†…å­˜ < 200MB
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|------|
          | ğŸªŸ Windows | `mira-windows-x64.zip` | Windows 10/11 x64 |
          | ğŸ macOS | `mira-macos-x64.tar.gz` | macOS 10.15+ x64/ARM64 |
          | ğŸ§ Linux | `mira-linux-x64.tar.gz` | Ubuntu 20.04+ / Debian 11+ |
          
          ### ï¿½ å¿«é€Ÿå¼€å§‹
          
          1. **ä¸‹è½½**: é€‰æ‹©é€‚åˆä½ ç³»ç»Ÿçš„å®‰è£…åŒ…
          2. **è§£å‹**: è§£å‹ä¸‹è½½çš„æ–‡ä»¶åˆ°ä»»æ„ç›®å½•
          3. **è¿è¡Œ**: 
             - Windows: åŒå‡» `mira.exe`
             - macOS/Linux: åœ¨ç»ˆç«¯è¿è¡Œ `./mira`
          4. **æˆæƒ**: é¦–æ¬¡è¿è¡Œæ—¶æˆäºˆæ‘„åƒå¤´è®¿é—®æƒé™
          5. **ä½¿ç”¨**: å¼€å§‹äº«å—æ¡Œé¢æ‘„åƒç²¾çµï¼
          
          ### ğŸ® æ“ä½œæŒ‡å—
          
          - **å·¦é”®æ‹–æ‹½**: ç§»åŠ¨çª—å£
          - **é¼ æ ‡æ»šè½®**: ç¼©æ”¾çª—å£ (Â±10%)
          - **Ctrl + æ»šè½®**: æ—‹è½¬çª—å£ (Â±15Â°)
          - **F1-F5**: åˆ‡æ¢å½¢çŠ¶ (åœ†å½¢/æ¤­åœ†/çŸ©å½¢/åœ†è§’çŸ©å½¢/å¿ƒå½¢)
          - **Tab**: åˆ‡æ¢æ‘„åƒå¤´è®¾å¤‡
          - **ç©ºæ ¼**: å¾ªç¯åˆ‡æ¢å½¢çŠ¶
          - **R**: é‡ç½®çª—å£ä½ç½®å’Œæ—‹è½¬
          
          ### ğŸ”’ å®‰å…¨éªŒè¯
          
          ä¸‹è½½åè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          ```bash
          sha256sum -c checksums.txt
          ```
          
          ### ğŸ“š æ–‡æ¡£
          
          - [å®Œæ•´æ–‡æ¡£](https://github.com/Vogadero/Mira/blob/main/README.md)
          - [å®‰è£…æŒ‡å—](https://github.com/Vogadero/Mira/blob/main/SETUP_GUIDE.md)
          - [éƒ¨ç½²æŒ‡å—](https://github.com/Vogadero/Mira/blob/main/DEPLOYMENT_GUIDE.md)
          
          ### ğŸ› é—®é¢˜åé¦ˆ
          
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/Vogadero/Mira/issues) ä¸­åé¦ˆã€‚
          
          ---
          
          **æ„å»ºä¿¡æ¯**
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
