name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Install dependencies
      run: |
        # ç¡®ä¿æœ‰å¿…è¦çš„å·¥å…·
        rustc --version
        cargo --version
    
    - name: Build release
      run: |
        cargo build --release --verbose
    
    - name: Run tests
      run: cargo test --release --verbose
    
    - name: Create distribution package
      run: |
        # åˆ›å»ºåˆ†å‘ç›®å½•
        New-Item -ItemType Directory -Force -Path dist
        
        # å¤åˆ¶æ–‡ä»¶
        Copy-Item target\release\mira.exe dist\
        Copy-Item README.md dist\
        Copy-Item LICENSE dist\
        
        # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
        echo "Mira Desktop Camera v1.0.0" | Out-File -FilePath dist\VERSION.txt -Encoding UTF8
        echo "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File -FilePath dist\VERSION.txt -Append -Encoding UTF8
        echo "Platform: Windows x64" | Out-File -FilePath dist\VERSION.txt -Append -Encoding UTF8
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        $size = (Get-Item target\release\mira.exe).Length / 1MB
        Write-Host "Binary size: $([math]::Round($size, 2)) MB"
        
        if ($size -gt 20) {
          Write-Warning "Binary size exceeds 20MB target"
        } else {
          Write-Host "âœ“ Binary size within target (<20MB)"
        }
    
    - name: Create ZIP archive
      run: |
        Compress-Archive -Path dist\* -DestinationPath mira-windows-x64.zip
        
        # æ£€æŸ¥å‹ç¼©åŒ…å¤§å°
        $zipSize = (Get-Item mira-windows-x64.zip).Length / 1MB
        Write-Host "ZIP size: $([math]::Round($zipSize, 2)) MB"
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: mira-windows-x64
        path: mira-windows-x64.zip
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Install dependencies
      run: |
        # å®‰è£…å¿…è¦å·¥å…·
        brew install bc
        rustc --version
        cargo --version
    
    - name: Build release
      run: |
        cargo build --release --verbose
    
    - name: Run tests
      run: cargo test --release --verbose
    
    - name: Create distribution package
      run: |
        # åˆ›å»ºåˆ†å‘ç›®å½•
        mkdir -p dist
        
        # å¤åˆ¶æ–‡ä»¶
        cp target/release/mira dist/
        cp README.md dist/
        cp LICENSE dist/
        
        # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
        cat > dist/VERSION.txt << EOF
        Mira Desktop Camera v1.0.0
        Build Date: $(date '+%Y-%m-%d %H:%M:%S')
        Platform: macOS x64
        EOF
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        size=$(du -m target/release/mira | cut -f1)
        echo "Binary size: ${size} MB"
        
        if [ $size -gt 25 ]; then
          echo "âš ï¸  Binary size exceeds 25MB target"
        else
          echo "âœ“ Binary size within target (<25MB)"
        fi
    
    - name: Create TAR archive
      run: |
        tar -czf mira-macos-x64.tar.gz -C dist .
        
        # æ£€æŸ¥å‹ç¼©åŒ…å¤§å°
        tarSize=$(du -m mira-macos-x64.tar.gz | cut -f1)
        echo "TAR size: ${tarSize} MB"
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: mira-macos-x64
        path: mira-macos-x64.tar.gz
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libssl-dev \
          libudev-dev \
          libv4l-dev \
          bc
    
    - name: Build release
      run: |
        cargo build --release --verbose
    
    - name: Run tests
      run: cargo test --release --verbose
    
    - name: Create distribution package
      run: |
        # åˆ›å»ºåˆ†å‘ç›®å½•
        mkdir -p dist
        
        # å¤åˆ¶æ–‡ä»¶
        cp target/release/mira dist/
        cp README.md dist/
        cp LICENSE dist/
        
        # åˆ›å»ºç‰ˆæœ¬æ–‡ä»¶
        cat > dist/VERSION.txt << EOF
        Mira Desktop Camera v1.0.0
        Build Date: $(date '+%Y-%m-%d %H:%M:%S')
        Platform: Linux x64
        EOF
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        size=$(du -m target/release/mira | cut -f1)
        echo "Binary size: ${size} MB"
        
        if [ $size -gt 30 ]; then
          echo "âš ï¸  Binary size exceeds 30MB target"
        else
          echo "âœ“ Binary size within target (<30MB)"
        fi
    
    - name: Create TAR archive
      run: |
        tar -czf mira-linux-x64.tar.gz -C dist .
        
        # æ£€æŸ¥å‹ç¼©åŒ…å¤§å°
        tarSize=$(du -m mira-linux-x64.tar.gz | cut -f1)
        echo "TAR size: ${tarSize} MB"
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: mira-linux-x64
        path: mira-linux-x64.tar.gz
        retention-days: 30

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: mira-windows-x64
        path: ./artifacts
    
    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: mira-macos-x64
        path: ./artifacts
    
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: mira-linux-x64
        path: ./artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./artifacts/mira-windows-x64.zip
          ./artifacts/mira-macos-x64.tar.gz
          ./artifacts/mira-linux-x64.tar.gz
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## Mira Desktop Camera v${{ github.ref_name }}
          
          ğŸ¥ **æ¡Œé¢æ‘„åƒç²¾çµ** - ç°ä»£åŒ–çš„æ¡Œé¢æ‘„åƒå¤´åº”ç”¨
          
          ### åŠŸèƒ½ç‰¹æ€§
          - ğŸ¨ 5ç§å½¢çŠ¶é®ç½©ï¼ˆåœ†å½¢ã€æ¤­åœ†ã€çŸ©å½¢ã€åœ†è§’çŸ©å½¢ã€å¿ƒå½¢ï¼‰
          - ğŸ–±ï¸ çµæ´»äº¤äº’ï¼ˆæ‹–æ‹½ã€ç¼©æ”¾ã€æ—‹è½¬ï¼‰
          - ğŸš€ é«˜æ€§èƒ½GPUæ¸²æŸ“ï¼ˆ30+ FPSï¼‰
          - ğŸ’¾ æ™ºèƒ½é…ç½®ä¿å­˜
          - ğŸŒ è·¨å¹³å°æ”¯æŒ
          
          ### ä¸‹è½½è¯´æ˜
          - **Windows**: ä¸‹è½½ `mira-windows-x64.zip`
          - **macOS**: ä¸‹è½½ `mira-macos-x64.tar.gz`
          - **Linux**: ä¸‹è½½ `mira-linux-x64.tar.gz`
          
          ### ä½¿ç”¨æ–¹æ³•
          1. è§£å‹ä¸‹è½½çš„æ–‡ä»¶
          2. è¿è¡Œ `mira` æˆ– `mira.exe`
          3. æˆäºˆæ‘„åƒå¤´æƒé™
          4. å¼€å§‹ä½¿ç”¨ï¼
          
          è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [README.md](https://github.com/Vogadero/Mira/blob/main/README.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  benchmark:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libssl-dev \
          libudev-dev \
          libv4l-dev
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: benchmark-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Run benchmarks
      run: |
        cargo bench --verbose
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: target/criterion/
        retention-days: 7